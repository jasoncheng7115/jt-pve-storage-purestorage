jt-pve-storage-purestorage (1.0.35-1) stable; urgency=medium

  * Fix Linked Clone to use proper PVE volume naming format:
    - clone_image now returns "base-X-disk-N/vm-Y-disk-M" for template clones
    - Added parse_volname support for linked clone format
    - Added pve_volname_to_pure support for linked clone format
    - parse_volname now returns proper basename/basevmid for linked clones
    - Fixes linked clone not showing parent relationship in PVE

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 25 Jan 2026 02:30:00 +0800

jt-pve-storage-purestorage (1.0.34-1) stable; urgency=medium

  * Document PVE Full Clone architecture limitation:
    - PVE GUI "Full Clone" always uses alloc + data copy (PVE design)
    - PVE does NOT call clone_image for Full Clone, bypasses storage plugin
    - Our clone_image supports instant clone from volume, but PVE won't call it
    - WORKAROUND: Use "Linked Clone" for instant cloning
    - Linked Clone uses Pure Storage instant clone via clone_image
    - After Linked Clone, delete source snapshot if independence is needed
    - Added detailed comments in plugin source explaining this limitation

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 25 Jan 2026 02:00:00 +0800

jt-pve-storage-purestorage (1.0.33-1) stable; urgency=medium

  * Fix slow list_images when no templates exist:
    - Was falling back to individual API calls for each volume
    - Now only falls back if batch query actually fails (not if empty)
    - Significantly improves list performance

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 18:40:00 +0800

jt-pve-storage-purestorage (1.0.32-1) stable; urgency=medium

  * Add clone_image support for direct volume clone:
    - clone_image now supports cloning directly from volume (not just snapshots)
    - Pure Storage supports instant clone from volume
    - NOTE: PVE GUI Full Clone does NOT use this (see 1.0.34 notes)

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 18:30:00 +0800

jt-pve-storage-purestorage (1.0.31-1) stable; urgency=medium

  * Optimize pod prefix queries for better performance:
    - Use pod.name filter to limit results when querying with pod prefix
    - Avoids fetching all volumes/snapshots when using pods
    - Significantly improves list/status speed for pod-based storage

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 18:20:00 +0800

jt-pve-storage-purestorage (1.0.30-1) stable; urgency=medium

  * Fix volume_list API call based on official Pure Storage documentation:
    - Use destroyed=false as query parameter (not in filter)
    - Use filter=name='pattern*' for wildcard patterns (without ::)
    - Pod prefix patterns (::) still filtered in Perl
    - Fixes "Unable to parse query" error

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 18:10:00 +0800

jt-pve-storage-purestorage (1.0.29-1) stable; urgency=medium

  * Fix API filter syntax for destroyed volumes:
    - Change "not destroyed" to "destroyed=false" (correct Pure API syntax)
    - Fixes "Syntax error in query" when listing volumes

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 18:00:00 +0800

jt-pve-storage-purestorage (1.0.28-1) stable; urgency=medium

  * Fix API filter syntax error with pod:: prefix:
    - volume_list: Handle pod::pattern* with Perl-side filtering
    - snapshot_list: Handle pod::pattern* with Perl-side filtering
    - Fixes "Syntax error in query" when listing volumes with pod prefix
  * Fix missing pod prefix in volume pattern queries:
    - _find_free_diskid: Add pod prefix to pattern
    - _cleanup_orphaned_temp_clones: Add pod prefix to pattern
    - list_images template query: Add pod prefix to snapshot pattern

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 17:56:00 +0800

jt-pve-storage-purestorage (1.0.27-1) stable; urgency=medium

  * Comprehensive udev trigger fix for all device operations:
    - Add udev trigger to activate_storage (iSCSI and FC)
    - Add udev trigger to path function (temp clone and quick rescan)
    - Add udev trigger to volume_resize (online resize)
    - Add udev trigger to volume_snapshot_rollback
    - Ensures consistent device discovery across all operations

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Sat, 24 Jan 2026 17:30:00 +0800

jt-pve-storage-purestorage (1.0.26-1) stable; urgency=medium

  * Fix device discovery for CT, VM clone, and all volume operations:
    - Add udev trigger to wait_for_multipath_device (Multipath module)
    - Add protocol-specific rescan callbacks (iSCSI/FC) to wait loop
    - Update activate_volume to pass iSCSI/FC rescan callback
    - Update path function temp clone handling with proper rescan
    - Fixes CT creation, VM clone, and other operations that use activate_volume

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 20:00:00 +0800

jt-pve-storage-purestorage (1.0.25-1) stable; urgency=medium

  * Add proper cleanup in deactivate_storage:
    - Cleanup local multipath and SCSI devices for storage volumes
    - Disconnect volumes from Pure Storage host
    - Logout iSCSI sessions if no more volumes connected
    - Flush unused multipath maps
    - Add host_get_volumes API function

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 19:30:00 +0800

jt-pve-storage-purestorage (1.0.24-1) stable; urgency=medium

  * Fix list_images showing destroyed volumes:
    - Add "not destroyed" filter to volume_list API call
    - Filter out destroyed volumes in API response (fallback)
    - Destroyed but not eradicated volumes no longer appear in PVE

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 19:00:00 +0800

jt-pve-storage-purestorage (1.0.23-1) stable; urgency=medium

  * Fix udev WWID cache issue causing device discovery failures:
    - Add udevadm trigger after SCSI rescan to refresh stale WWIDs
    - Fixes issue where new volume reusing LUN ID shows old WWID
    - Root cause of "device did not appear" error for state volumes

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 18:30:00 +0800

jt-pve-storage-purestorage (1.0.22-1) stable; urgency=medium

  * Add automatic multipath configuration for Pure Storage:
    - Auto-detect and create multipath config if missing
    - Use /etc/multipath/conf.d/ if available (non-invasive)
    - Safely append to existing /etc/multipath.conf if needed
    - Only adds Pure Storage device section, preserves other configs
    - Called during activate_storage

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 18:00:00 +0800

jt-pve-storage-purestorage (1.0.21-1) stable; urgency=medium

  * Improve RAM snapshot device discovery diagnostics:
    - Add verbose logging during device wait loop (first 3 iterations)
    - Verify iSCSI sessions exist before rescanning
    - Auto re-establish iSCSI sessions if none found
    - Add extra 1-second delay after iSCSI rescan for kernel processing
    - Increase initial connection propagation delay to 3 seconds
    - Add detailed debug commands in error message
    - Show iSCSI session count in diagnostic output

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 17:00:00 +0800

jt-pve-storage-purestorage (1.0.20-1) stable; urgency=medium

  * Fix orphaned state/cloudinit volume cleanup:
    - Auto-detect and cleanup orphaned volumes from previous failed attempts
    - Disconnect all host connections before deleting orphaned volume
    - Provide clear error message if cleanup fails (manual deletion required)
    - Fixes "Volume already exists" error when retrying RAM snapshot

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 16:00:00 +0800

jt-pve-storage-purestorage (1.0.19-1) stable; urgency=medium

  * Fix RAM snapshot device discovery (improved):
    - Add 2 second delay for Pure Storage to propagate connection
    - Include iSCSI/FC session rescan in the wait loop (was missing!)
    - Rescan protocol-specific + SCSI + multipath in every iteration
    - Improve error message with WWID and troubleshooting commands
    - The previous fix only did one iSCSI rescan before the wait loop

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 15:00:00 +0800

jt-pve-storage-purestorage (1.0.18-1) stable; urgency=medium

  * Fix RAM snapshot device discovery:
    - Add iSCSI/FC rescan after creating state/cloudinit volumes
    - Wait for device to appear before returning from alloc_image
    - Fix "Device did not appear" error when creating RAM snapshots
    - Cleanup state volume if device discovery fails

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 14:00:00 +0800

jt-pve-storage-purestorage (1.0.17-1) stable; urgency=medium

  * Fix RAM snapshot (Include RAM) support:
    - Handle vm-{vmid}-state-{snapname} volume type in alloc_image
    - Handle vm-{vmid}-cloudinit volume type in alloc_image
    - Previously caused "Volume already exists" error when creating
      snapshot with "Include RAM" option checked

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 13:00:00 +0800

jt-pve-storage-purestorage (1.0.16-1) stable; urgency=medium

  * Comprehensive error handling improvements:
    - Add existence checks for all snapshot operations
    - Improve volume_snapshot_delete with dependency detection
    - Add volume_snapshot_rollback validation and safety checks
    - Improve clone_image with source validation and better error messages
    - Add linked clone support validation (template vs snapshot)
    - Improve create_base with in-use detection
    - Add host/initiator conflict detection and helpful error messages
    - Add detailed device discovery failure diagnostics
    - Add capacity/quota error detection
  * Migration support improvements:
    - Add _connect_to_all_hosts() helper for cluster-wide volume access
    - Volumes now connected to all cluster hosts on creation
    - Support container (CT) storage with rootdir content type
  * Code refactoring:
    - Consolidate host connection logic into reusable helper
    - Improve cleanup on partial operation failures

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 12:00:00 +0800

jt-pve-storage-purestorage (1.0.15-1) stable; urgency=medium

  * FC support improvements:
    - Use raw WWN format (no colons) for Pure Storage API compatibility
    - Add normalize_wwn() for format-agnostic WWN comparison
    - Add get_fc_wwpns_raw() for API-compatible WWPN retrieval
    - Handle API 2.x 'wwns'/'iqns' and API 1.x 'wwnlist'/'iqnlist' formats
    - Normalize WWN comparison when checking existing host initiators

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Fri, 24 Jan 2026 10:00:00 +0800

jt-pve-storage-purestorage (1.0.14-1) stable; urgency=medium

  * Fix snapshot suffix: replace underscore and dot with dash
  * Pure Storage snapshot suffix only allows alphanumeric and '-'
  * Add detailed comments about naming restrictions

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 23:15:00 +0800

jt-pve-storage-purestorage (1.0.12-1) stable; urgency=medium

  * Fix pod prefix missing in all volume operations
  * Fix deactivate_volume, path, volume_snapshot, volume_snapshot_delete
  * Fix volume_snapshot_rollback, volume_snapshot_list, create_base
  * Fix rename_volume, clone_image to use pod prefix

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 22:30:00 +0800

jt-pve-storage-purestorage (1.0.11-1) stable; urgency=medium

  * Fix API 2.x volume size field: use 'provisioned' instead of 'size'
  * Fix API 2.x used space: use 'space.total_physical' instead of 'volumes'
  * Update list_images, volume_size_info, volume_resize for API 2.x

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 22:00:00 +0800

jt-pve-storage-purestorage (1.0.10-1) stable; urgency=medium

  * Fix API 2.x wildcard queries: use filter parameter instead of names
  * volume_list: filter=name='pattern*' for wildcard patterns
  * snapshot_list: filter=name='pattern*' for wildcard patterns

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 21:30:00 +0800

jt-pve-storage-purestorage (1.0.9-1) stable; urgency=medium

  * Fix API 2.x: names/source_names must be in query string, not body
  * Fix volume_create: POST /volumes?names=volname
  * Fix volume_clone: POST /volumes?names=volname with source in body
  * Fix snapshot_create: POST /volume-snapshots?source_names=volname
  * Fix volume_connect_host: POST /connections?host_names=x&volume_names=y
  * Fix volume_connect_hgroup: POST /connections?host_group_names=x&volume_names=y
  * URL-encode pod::volname format (:: becomes %3A%3A) in query strings

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 21:00:00 +0800

jt-pve-storage-purestorage (1.0.8-1) stable; urgency=medium

  * Show pod quota limit as storage capacity when configured
  * Add pod_get API function for pod information

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 20:30:00 +0800

jt-pve-storage-purestorage (1.0.7-1) stable; urgency=medium

  * Add pure-pod option for ActiveCluster configurations
  * Support pod-prefixed volume names (pod::volname format)
  * Fix volume creation when File service is enabled

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 20:00:00 +0800

jt-pve-storage-purestorage (1.0.6-1) stable; urgency=medium

  * Fix API 2.x host creation: use query parameter for names
  * POST /hosts?names=hostname with iqns/wwns in body

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 19:30:00 +0800

jt-pve-storage-purestorage (1.0.5-1) stable; urgency=medium

  * Fix API 2.x endpoints: arrays, ports, network-interfaces
  * Handle API 2.x response format with {items: [...]}
  * Fix capacity reporting for API 2.x nested space object

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 19:00:00 +0800

jt-pve-storage-purestorage (1.0.4-1) stable; urgency=medium

  * Use API 2.x with POST /login endpoint for authentication
  * Detect API version via /api/api_version endpoint
  * Get x-auth-token from login response header
  * Support API versions up to 2.42

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 18:30:00 +0800

jt-pve-storage-purestorage (1.0.3-1) stable; urgency=medium

  * Implement two-stage authentication like kolesa-team plugin
  * Use POST /auth/session with api-token to get x-auth-token
  * Use x-auth-token for all subsequent API requests

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 13:00:00 +0800

jt-pve-storage-purestorage (1.0.2-1) stable; urgency=medium

  * Fix Content-Type header issue on GET requests causing 401 errors
  * Only set Content-Type for POST/PUT/PATCH requests

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 12:30:00 +0800

jt-pve-storage-purestorage (1.0.1-1) stable; urgency=medium

  * Fix API version detection for Pure Storage arrays without API 2.x
  * Improve 401 authentication error diagnostics
  * Handle Pure Storage API returning HTTP 200 with error body

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Thu, 23 Jan 2026 12:00:00 +0800

jt-pve-storage-purestorage (1.0.0-1) stable; urgency=medium

  * Initial release
  * Support for Pure Storage FlashArray via iSCSI and FC
  * Volume management: create, delete, resize
  * Snapshot: create, delete, rollback
  * Clone support via Pure Storage snapshots
  * Template support
  * Multipath I/O support
  * Live migration support

 -- Jason Cheng (Jason Tools) <jason@jason.tools>  Mon, 13 Jan 2026 00:00:00 +0800
